<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BullionBase - Portfolio Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.21.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.21.0/firebase-database-compat.js"></script>
    <style>
        body {
            background: linear-gradient(to right, #fafafa, #f5f5f5);
            background-attachment: fixed;
            font-family: 'Inter', sans-serif;
        }
        .dashboard-title {
            color: #B6862A;
        }
        .card {
            background: #fff;
            border: 1px solid #e2e8f0;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
        }
        .button-primary {
            background-color: #B6862A;
            color: white;
        }
        .button-primary:hover {
            background-color: #A2751E;
        }
        .modal-overlay {
            background: rgba(0, 0, 0, 0.5);
        }
        .modal-container {
            background: linear-gradient(to right, #f9f9f9, #f3f3f3);
            border: 2px solid #B6862A;
            padding: 1.5rem;
            border-radius: 0.5rem;
            width: 100%;
            max-width: 400px;
            text-align: center;
        }
        .checkmark-circle {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            background: #B6862A;
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 0 auto 1rem;
        }
        .checkmark {
            font-size: 40px;
            color: white;
        }
        .modal-title {
            color: #B6862A;
        }
        .btn-close {
            background-color: #B6862A;
            color: white;
            font-weight: bold;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            transition: background-color 0.3s ease;
        }
        .btn-close:hover {
            background-color: #A2751E;
        }
    </style>
</head>
<body>
    <nav class="bg-gradient-to-r from-gray-800 to-gray-900 text-white shadow-lg">
        <div class="container mx-auto px-6 py-4 flex justify-between items-center">
            <h1 class="text-2xl font-extrabold tracking-wide text-yellow-400">
                BullionBase
            </h1>
    
            <div class="hidden md:flex space-x-8">
                <a href="index.html" class="hover:text-yellow-400 font-semibold transition duration-300">
                    Dashboard
                </a>
                <a href="add-collection.html" class="hover:text-yellow-400 font-semibold transition duration-300">
                    Add to Collection
                </a>
            </div>
    
            <div id="wallet-container" class="flex space-x-4 items-center">
                <!-- Wallet Selector Dropdown -->
                <select
                    id="wallet-selector"
                    class="bg-gray-700 text-white px-4 py-2 rounded-md border border-gray-600 focus:outline-none focus:ring-2 focus:ring-yellow-400 transition duration-300 hidden"
                    onchange="switchWallet()"
                >
                    <option value="">Select Wallet</option>
                </select>
                <!-- Create Wallet Button -->
                <button
                    onclick="createWallet()"
                    class="bg-yellow-400 text-gray-900 px-5 py-2 rounded-md font-bold hover:bg-yellow-500 transition duration-300 shadow-lg"
                >
                    Create Wallet
                </button>
            </div>
    
            <button class="block md:hidden text-white focus:outline-none" onclick="toggleMobileMenu()">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M4 6h16M4 12h16m-7 6h7"
                    />
                </svg>
            </button>
        </div>
        <div id="mobile-menu" class="hidden md:hidden bg-gray-800 p-4">
            <a href="index.html" class="block text-white hover:text-yellow-400 font-semibold py-2">Dashboard</a>
            <a href="add-collection.html" class="block text-white hover:text-yellow-400 font-semibold py-2">Add to Collection</a>
        </div>
    </nav>
    
    <script>
        // Function to check wallets and update UI
        function checkWallets() {
            const userId = "demo_user"; // Replace with actual user ID logic
            const walletsRef = database.ref(`users/${userId}/wallets`);
            const walletSelector = document.getElementById("wallet-selector");
    
            walletsRef.once("value", (snapshot) => {
                const wallets = snapshot.val() || {};
                const walletKeys = Object.keys(wallets);
    
                // If wallets exist, show the dropdown
                if (walletKeys.length > 0) {
                    walletSelector.classList.remove("hidden");
                    walletSelector.innerHTML = `<option value="">Select Wallet</option>`;
                    walletKeys.forEach((walletKey) => {
                        const option = document.createElement("option");
                        option.value = walletKey;
                        option.textContent = wallets[walletKey].name || walletKey;
                        walletSelector.appendChild(option);
                    });
                } else {
                    // Hide the dropdown if no wallets
                    walletSelector.classList.add("hidden");
                }
            });
        }
    
        // Initialize function to call at page load
        function init() {
            checkWallets(); // Check wallets on page load
        }
    
        init(); // Call init on page load
    </script>
    
    
    <script>
        function toggleMobileMenu() {
            const mobileMenu = document.getElementById("mobile-menu");
            mobileMenu.classList.toggle("hidden");
        }
    </script>

<div class="container mx-auto my-8 px-4">
    <div class="flex justify-between items-center mb-6">
        <h1 class="text-4xl font-extrabold dashboard-title">Portfolio Summary</h1>
        <div class="flex space-x-4">
            <!-- List View Button -->
            <button id="list-view-btn" class="p-2 rounded-md bg-yellow-400 hover:bg-yellow-500 transition">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-800" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4h6v6H4zM14 4h6v6h-6zM4 14h6v6H4zM14 14h6v6H14z" />
                </svg>
            </button>
            <!-- Grid View Button -->
            <button id="grid-view-btn" class="p-2 rounded-md bg-gray-300 hover:bg-gray-400 transition">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-800" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
                </svg>
            </button>
        </div>
    </div>

    <!-- Portfolio Summary -->
    <div id="portfolio-summary" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
        <div class="card rounded-lg p-6 text-center">
            <h2 class="text-lg font-semibold text-gray-700">Sell Value</h2>
            <p id="sell-price" class="text-3xl font-bold text-gray-900 mt-2">$0.00</p>
            <p class="text-sm text-gray-500">Value if sold to VBCE</p>
        </div>
        <div class="card rounded-lg p-6 text-center">
            <h2 class="text-lg font-semibold text-gray-700">Buy Value</h2>
            <p id="buy-price" class="text-3xl font-bold text-gray-900 mt-2">$0.00</p>
            <p class="text-sm text-gray-500">Cost to replace portfolio</p>
        </div>
        <div class="card rounded-lg p-6 text-center">
            <h2 class="text-lg font-semibold text-gray-700">Total Gold</h2>
            <p id="total-gold" class="text-3xl font-bold text-gray-900 mt-2">0 oz</p>
            <p class="text-sm text-gray-500">Total weight of gold in portfolio</p>
        </div>
        <div class="card rounded-lg p-6 text-center">
            <h2 class="text-lg font-semibold text-gray-700">Total Silver</h2>
            <p id="total-silver" class="text-3xl font-bold text-gray-900 mt-2">0 oz</p>
            <p class="text-sm text-gray-500">Total weight of silver in portfolio</p>
        </div>
    </div>
</div>

<script>
    const gridViewBtn = document.getElementById('grid-view-btn');
    const listViewBtn = document.getElementById('list-view-btn');
    const portfolioSummary = document.getElementById('portfolio-summary');

    // Load the user's preference from localStorage
    const savedLayout = localStorage.getItem('portfolioLayout') || 'grid';
    applyLayout(savedLayout);

    gridViewBtn.addEventListener('click', () => {
        applyLayout('grid');
        localStorage.setItem('portfolioLayout', 'grid');
    });

    listViewBtn.addEventListener('click', () => {
        applyLayout('list');
        localStorage.setItem('portfolioLayout', 'list');
    });

    function applyLayout(layout) {
        if (layout === 'grid') {
            portfolioSummary.className = 'grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6';
            gridViewBtn.classList.add('bg-yellow-400');
            gridViewBtn.classList.remove('bg-gray-300');
            listViewBtn.classList.remove('bg-yellow-400');
            listViewBtn.classList.add('bg-gray-300');
        } else {
            portfolioSummary.className = 'grid grid-cols-1 md:grid-cols-2 gap-6';
            listViewBtn.classList.add('bg-yellow-400');
            listViewBtn.classList.remove('bg-gray-300');
            gridViewBtn.classList.remove('bg-yellow-400');
            gridViewBtn.classList.add('bg-gray-300');
        }
    }
</script>


 <div class="container mx-auto my-8 px-4">
        <h2 class="text-3xl font-bold text-center mb-8 dashboard-title">Your Collection</h2>
        <div id="dashboard" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-8"></div>
        <div class="text-center mt-8">
            <a href="add-collection.html" class="button-primary px-6 py-3 rounded-md shadow-md hover:bg-yellow-600 font-semibold">
                Add to Collection
            </a>
        </div>
    </div>

    <div id="modal" class="hidden fixed inset-0 z-50 flex items-center justify-center modal-overlay">
        <div class="modal-container">
            <div class="checkmark-circle">
                <div class="checkmark">✔</div>
            </div>
            <h2 id="modal-title" class="modal-title text-2xl font-bold mt-4">Success</h2>
            <p id="modal-body" class="text-gray-700 mt-2">Item removed successfully!</p>
            <button id="close-modal" class="btn-close mt-6">Got it</button>
        </div>
    </div>
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyBGL4qe8Qf4t0KqSkB48One76sV2HHbmjY",
            authDomain: "cangoldinvestment.firebaseapp.com",
            databaseURL: "https://cangoldinvestment-default-rtdb.firebaseio.com",
            projectId: "cangoldinvestment",
            storageBucket: "cangoldinvestment.appspot.com",
            messagingSenderId: "1052369951680",
            appId: "1:1052369951680:web:5c0a1bb89a58df91718625"
        };
    
        console.log("Initializing Firebase...");
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
    
        let vbcePrices = {};
        let currentWallet = localStorage.getItem("currentWallet") || "";
    
        async function fetchVbcePrices() {
            console.log("Fetching VBCE prices...");
            try {
                const response = await fetch('https://rs1.smallfactory.dev/api/v1/metals?apikey=bc9959c3faab76071c6fb348c509f7f32');
                const data = await response.json();
                vbcePrices = data.reduce((acc, item) => {
                    const sell = Math.min(item.buy, item.sell);
                    const buy = Math.max(item.buy, item.sell);
                    acc[item.name] = { buy: buy, sell: sell };
                    return acc;
                }, {});
                console.log("VBCE prices fetched successfully:", vbcePrices);
            } catch (error) {
                console.error("Error fetching VBCE prices:", error);
            }
        }
    
        function fetchUserCollection() {
            console.log("Fetching user collection for wallet:", currentWallet);
            if (!currentWallet) {
                console.warn("No wallet selected. Skipping collection fetch.");
                return;
            }
    
            const userId = "demo_user";
            const collectionRef = database.ref(`users/${userId}/wallets/${currentWallet}/collection`);
    
            collectionRef.on("value", async (snapshot) => {
                const data = snapshot.val() || {};
                console.log("User collection fetched:", data);
                await calculatePortfolioValue(data);
                displayUserCollection(data);
            });
        }
    
        function extractWeight(name) {
            if (name.toLowerCase().includes("kg") || name.toLowerCase().includes("kilo")) {
                const kgMatch = name.match(/(\d+(\.\d+)?)\s*(kg|kilo)/i);
                return kgMatch ? parseFloat(kgMatch[1]) * 35.27396195 : 0;
            }
    
            const ozMatch = name.match(/(\d+(\.\d+)?)\s*oz/i);
            return ozMatch ? parseFloat(ozMatch[1]) : 0;
        }
    
        async function calculatePortfolioValue(collection) {
            console.log("Calculating portfolio value...");
            let totalSellValue = 0;
            let totalBuyValue = 0;
            let totalGoldWeightOz = 0;
            let totalSilverWeightOz = 0;
    
            for (const key in collection) {
                const item = collection[key];
                const vbceItem = vbcePrices[item.name];
                const weight = extractWeight(item.name);
    
                if (vbceItem) {
                    totalSellValue += vbceItem.sell * item.quantity;
                    totalBuyValue += vbceItem.buy * item.quantity;
    
                    if (item.name.toLowerCase().includes("gold")) {
                        totalGoldWeightOz += weight * item.quantity;
                    } else if (item.name.toLowerCase().includes("silver")) {
                        totalSilverWeightOz += weight * item.quantity;
                    }
                } else {
                    console.warn(`No pricing data found for item: ${item.name}`);
                }
            }
    
            document.getElementById("sell-price").textContent = `$${totalSellValue.toFixed(2)}`;
            document.getElementById("buy-price").textContent = `$${totalBuyValue.toFixed(2)}`;
            document.getElementById("total-gold").textContent = `${totalGoldWeightOz.toFixed(2)} oz`;
            document.getElementById("total-silver").textContent = `${totalSilverWeightOz.toFixed(2)} oz`;
    
            console.log("Portfolio values updated.");
        }
    
        function displayUserCollection(collection) {
            console.log("Displaying user collection...");
            const dashboard = document.getElementById("dashboard");
            dashboard.innerHTML = "";
    
            for (const key in collection) {
                const item = collection[key];
                const vbceItem = vbcePrices[item.name];
    
                const itemElement = document.createElement("div");
                itemElement.classList.add("card", "p-4", "rounded-lg", "shadow", "flex", "justify-between", "items-center");
    
                itemElement.innerHTML = `
                    <div>
                        <h3 class="text-lg font-semibold text-gray-700">${item.name}</h3>
                        <p class="text-sm text-gray-500">Quantity: ${item.quantity}</p>
                        <p class="text-sm text-gray-500">Sell Value: $${(item.quantity * vbceItem?.buy || 0).toFixed(2)}</p>
                        <p class="text-sm text-gray-500">Buy Value: $${(item.quantity * vbceItem?.sell || 0).toFixed(2)}</p>
                    </div>
                    <button onclick="removeItem('${item.name}')" class="text-red-500 hover:text-red-600">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                `;
                dashboard.appendChild(itemElement);
            }
    
            console.log("User collection displayed.");
        }
    
        function removeItem(itemName) {
            console.log(`Attempting to remove item: ${itemName}`);
            const userId = "demo_user";
            const collectionRef = database.ref(`users/${userId}/wallets/${currentWallet}/collection`);
    
            collectionRef.once("value", (snapshot) => {
                const data = snapshot.val();
                let itemKey = null;
    
                for (const key in data) {
                    if (data[key].name === itemName) {
                        itemKey = key;
                        break;
                    }
                }
    
                if (itemKey) {
                    database.ref(`users/${userId}/wallets/${currentWallet}/collection/${itemKey}`).remove()
                        .then(() => {
                            console.log(`${itemName} removed successfully.`);
                            fetchUserCollection();
                            showModal("Success", `${itemName} removed successfully!`);
                        })
                        .catch((error) => {
                            console.error("Error removing item:", error);
                            showModal("Error", "Failed to remove item. Try again.");
                        });
                } else {
                    console.warn(`Item not found: ${itemName}`);
                    showModal("Error", "Item not found in the collection.");
                }
            });
        }
    
        function fetchWallets() {
            console.log("Fetching wallets...");
            const userId = "demo_user";
            const walletsRef = database.ref(`users/${userId}/wallets`);
    
            walletsRef.on("value", (snapshot) => {
                const wallets = snapshot.val() || {};
                const walletSelector = document.getElementById("wallet-selector");
    
                walletSelector.innerHTML = `<option value="">Select Wallet</option>`;
                for (const walletId in wallets) {
                    const option = document.createElement("option");
                    option.value = walletId;
                    option.textContent = wallets[walletId].name || walletId;
                    walletSelector.appendChild(option);
                }
    
                if (!currentWallet && Object.keys(wallets).length > 0) {
                    currentWallet = Object.keys(wallets)[0];
                    localStorage.setItem("currentWallet", currentWallet);
                }
    
                if (currentWallet) {
                    walletSelector.value = currentWallet;
                    fetchUserCollection();
                }
    
                console.log("Wallets fetched:", wallets);
            });
        }
    
        function createWallet() {
            const walletName = prompt("Enter a name for the new wallet:");
            if (walletName) {
                console.log(`Creating wallet: ${walletName}`);
                const userId = "demo_user";
                const walletsRef = database.ref(`users/${userId}/wallets`);
    
                const newWalletRef = walletsRef.push();
                newWalletRef.set({ name: walletName, collection: {} }, (error) => {
                    if (error) {
                        console.error("Error creating wallet:", error);
                        showModal("Error", "Failed to create wallet.");
                    } else {
                        console.log(`Wallet "${walletName}" created successfully.`);
                        currentWallet = newWalletRef.key;
                        localStorage.setItem("currentWallet", currentWallet);
                        fetchWallets();
                    }
                });
            }
        }
    
        function switchWallet() {
            const walletSelector = document.getElementById("wallet-selector");
            currentWallet = walletSelector.value;
            localStorage.setItem("currentWallet", currentWallet);
            console.log("Switched to wallet:", currentWallet);
            fetchUserCollection();
        }
    
        function showModal(title, body) {
            console.log(`Showing modal - Title: ${title}, Body: ${body}`);
            const modal = document.getElementById("modal");
            document.getElementById("modal-title").textContent = title;
            document.getElementById("modal-body").textContent = body;
            modal.classList.remove("hidden");
    
            const closeModal = () => modal.classList.add("hidden");
            document.getElementById("close-modal").addEventListener("click", closeModal);
            modal.addEventListener("click", (e) => e.target === modal && closeModal());
            document.addEventListener("keydown", (e) => e.key === "Escape" && closeModal());
        }
    
        async function init() {
            console.log("Initializing application...");
            await fetchVbcePrices();
            fetchWallets();
        }
    
        init();
    </script>
    
</body>
</html>
